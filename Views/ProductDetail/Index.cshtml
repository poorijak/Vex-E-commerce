@model Vex_E_commerce.Models.ProductDetailDTO;

@{
    ViewData["Title"] = "รายการสินค้า";

    var colorList = new[]
{
        new { style = "bg-red-600"      },
        new { style = "bg-neutral-900"  },
        new { style = "bg-white border" },
    };

}

<div class="mx-10 pt-40 md:mx-40 md:pt-24">

    <div class="mt-5 flex items-center pb-6 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="fill-muted-foreground size-3" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path></svg>
        <a asp-action="Index" asp-controller="Home" class="text-muted-foreground px-2 group-hover::text-black">Home</a>
        <a asp-action="Index" asp-controller="ProductDetail" class="px-2 font-medium">@Model.Product.Title</a>
    </div>

    <div class="grid grid-cols-1 gap-8 md:gap-10 lg:grid-cols-2">

        @* Product image: ให้ภาพแสดงเต็มพื้นที่ในมือถือ *@
        <img src="@Model.Product.PictureUrl" alt="Product-Image" loading="lazy" class="size-full border border-border object-cover" />

        <div class="md:pl-10">
            @* ลด padding บน desktop และใช้ได้ดีใน mobile *@
            <div>
                <p class="text-muted-foreground pb-2 text-xs md:text-sm">@ViewBag.categoryTitle</p>

                <div class="flex items-start justify-between">
                    <h1 class="pb-3 text-3xl font-bold md:text-4xl">@Model.Product.Title</h1>
                </div>

                <form method="post" asp-controller="Cart" asp-action="Add" id="addToCartForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ProductId" value="@Model.Product.Id" />

                    <div class="mt-4 mb-2 text-base font-semibold">Select color</div>
                    <div class="flex gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="Color" value="Red" class="peer hidden" />
                            <div class="h-8 w-8 rounded-md border-2 border-gray-300 bg-red-600 transition-all duration-150 peer-checked:border-black"></div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="Color" value="Black" class="peer hidden" />
                            <div class="h-8 w-8 rounded-md border-2 border-gray-300 bg-black transition-all duration-150 peer-checked:border-black"></div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="Color" value="White" class="peer hidden" />
                            <div class="h-8 w-8 rounded-md border-2 border-gray-300 bg-white transition-all duration-150 peer-checked:border-black"></div>
                        </label>
                    </div>

                    <div class="mt-6 mb-3 text-base font-semibold">Select size</div>

                    <div class="mt-3 flex flex-wrap gap-2 sm:gap-4">
                        @* ใช้ flex-wrap และลด gap บนมือถือ *@
                        @{
                            var sizes = new[] { "XS", "S", "M", "L", "XL", "XXL" };
                            var sizeStock = ViewBag.SizeStock as Dictionary<string, int>;
                        }
                        @foreach (var size in sizes)
                        {
                            var stock = sizeStock != null && sizeStock.ContainsKey(size) ? sizeStock[size] : 0;
                            var disabled = stock <= 0 ? "disabled opacity-50 cursor-not-allowed" : "";

                           <div>
                                <input type="radio" id="size-@size.ToLower()" name="Size" value="@size" class="peer hidden" @(stock <= 0 ? "disabled" : "") />
                                <label for="size-@size.ToLower()" class="duration- 50 flex w-16 cursor-pointer items-center justify-center rounded
                                            border border-black bg-white px-1
                                            py-2 text-center text-sm
                                            text-black transition peer-checked:border-black peer-checked:bg-black
                                                peer-checked:text-white
                    hover:border-black
                    sm:w-20
                                            @disabled">
                                    <span class="size-text">@size</span>
                                    (<span class="size-stock">@stock</span>)
                                </label>
                           </div>
                        }
                    </div>

                    <div class="pt-8">
                        <h2 class="text-lg font-semibold">Description</h2>
                        <p class="pt-3 text-sm text-gray-600">@Model.Product.Description</p> @* ปรับขนาดตัวอักษรเป็น text-sm *@
                    </div>

                    <div class="pt-10">
                        <button type="submit" class="w-full border-primary bg-black px-2 py-2 text-lg font-medium text-white transition duration-150 hover:cursor-pointer hover:border hover:bg-white hover:text-primary">Add To Cart</button>
                    </div>


                </form>


            </div>
        </div>
    </div>

    <div class="mt-10 h-px border-b border-border"></div>


    <figure class="mt-30">
        <h2 class="flex items-center gap-2 text-3xl font-medium">
            Biggest
            <span class="font-bold">Sales</span>
            Ever
        </h2>
        <div class="mt-10 grid grid-cols-2 gap-4 md:grid-cols-3 md:gap-10 lg:grid-cols-5">
            @foreach (var i in Model.RelateProducts)
            {
                <div class="font-geist flex flex-col rounded-md border border-border bg-white p-4">
                    <a asp-route-id="@i.Id" asp-action="Index" asp-controller="ProductDetail">
                        <div class="flex justify-end">
                            <p class="text-muted-foreground text-xs font-medium">@i.TotalSold SOLD</p>
                        </div>

                        <div class="my-4 flex items-center justify-center overflow-hidden">
                            <img src="@i.PictureUrl" alt="Relate-Product" class="size-24 object-cover md:size-28" />
                        </div>

                        <div class="flex flex-col gap-1">
                            <label class="line-clamp-1 text-base font-semibold">@i.Title</label>
                            <div class="mt-1 flex gap-1">
                                @foreach (var c in colorList)
                                {
                                    <div class="@c.style size-3 rounded-xs border border-border hover:cursor-pointer md:size-4">
                                    </div>
                                }
                            </div>
                        </div>
                    </a>
                    <div class="flex items-end justify-between">
                        <div class="mt-3 flex flex-col gap-1">
                            <p class="text-muted-foreground text-xs font-medium md:text-xs">Start From</p>
                            <p class="text-sm font-semibold">฿ @i.BasePrice</p>
                        </div>
                        <form method="post" asp-action="ToggleWishList" class="wishlist-form" asp-controller="ProductDetail" data-product-itemid="@i.Id">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="productId" value="@i.Id" />
                            <button type="submit" class="heart-btn" aria-label="Wishlist">
                                <svg xmlns="http://www.w3.org/2000/svg" class="heart-outline @(i.IsWishlisted ? "hidden" : "") size-6" viewBox="0 0 256 256"><path d="M178,40c-20.65,0-38.73,8.88-50,23.89C116.73,48.88,98.65,40,78,40a62.07,62.07,0,0,0-62,62c0,70,103.79,126.66,108.21,129a8,8,0,0,0,7.58,0C136.21,228.66,240,172,240,102A62.07,62.07,0,0,0,178,40ZM128,214.8C109.74,204.16,32,155.69,32,102A46.06,46.06,0,0,1,78,56c19.45,0,35.78,10.36,42.6,27a8,8,0,0,0,14.8,0c6.82-16.67,23.15-27,42.6-27a46.06,46.06,0,0,1,46,46C224,155.61,146.24,204.15,128,214.8Z"></path></svg>
                                <svg xmlns="http://www.w3.org/2000/svg" class="heart-fill size-6 fill-destructive @(i.IsWishlisted ? "" : "hidden")" viewBox="0 0 256 256"><path d="M240,102c0,70-103.79,126.66-108.21,129a8,8,0,0,1-7.58,0C119.79,228.66,16,172,16,102A62.07,62.07,0,0,1,78,40c20.65,0,38.73,8.88,50,23.89C139.27,48.88,157.35,40,178,40A62.07,62.07,0,0,1,240,102Z"></path></svg>
                            </button>
                        </form>
                    </div>
                </div>
            }
        </div>
    </figure>
</div>

@section Scripts {

    <script>

        const variants = @Html.Raw(ViewBag.VariantsJson);



        // อัปเดต size stock ตามสีที่เลือก

            document.querySelectorAll('input[name="Color"]').forEach(cb => {

            cb.addEventListener('change', function () {

                const selectedColor = this.value;

                const sizeInputs = document.querySelectorAll('input[name="Size"]');



                sizeInputs.forEach(input => {

                    const size = input.value;

                    const variant = variants.find(v => v.color === selectedColor && v.size === size);

                    const stock = variant ? variant.stock : 0;



                    const label = document.querySelector(`label[for="size-${size.toLowerCase()}"]`);

                    const stockSpan = label.querySelector('.size-stock');



                    // อัปเดต stock เฉพาะ span

                    stockSpan.innerText = stock;



                    // ปิด/เปิดปุ่มตาม stock

                    if (stock <= 0) {

                        input.disabled = true;

                        label.classList.add("opacity-50", "cursor-not-allowed");

                    } else {

                        input.disabled = false;

                        label.classList.remove("opacity-50", "cursor-not-allowed");

                    }

                });

            });

        });





        // Highlight size เมื่อเลือก (Tailwind peer-checked ใช้แล้ว)



        // Submit form เดิม

        document.getElementById("addToCartForm").addEventListener("submit", async function (e) {

            e.preventDefault();



            const formData = new FormData(this);



            const res = await fetch("/cart/add", {

                method: "POST",

                body: formData

            });



            const json = await res.json();



            if (json.ok) {

                window.location.href = "/cart/view/" + json.cartId;

            }

        });

    </script>

}
