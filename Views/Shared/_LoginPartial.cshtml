@using Microsoft.AspNetCore.Identity
@using Vex_E_commerce.Data
@using Vex_E_commerce.Models
@using Microsoft.EntityFrameworkCore

@inject SignInManager<Customer> SignInManager
@inject UserManager<Customer> UserManager
@inject ApplicationDbContext _db

<div class="flex gap-3">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);
        var pictureProfile = "/images/Avatar/Avatar.webp";

        var cartCount = 0;
        try
        {
            cartCount = _db.CartItems
            .Where(ci => ci.Cart.UserId == user.Id)
            .Sum(ci => ci.Quantity);
        }
        catch
        {
            cartCount = 0;
        }

        <div class="flex items-center justify-center gap-4">

            @* --- ส่วนตะกร้าสินค้า (Cart) --- *@
            <div class="relative">
                <a href="/cart" class="flex items-center justify-center" aria-label="Link to Cart Page">
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-6 fill-primary" viewBox="0 0 256 256"><path d="M104,216a16,16,0,1,1-16-16A16,16,0,0,1,104,216Zm88-16a16,16,0,1,0,16,16A16,16,0,0,0,192,200ZM239.71,74.14l-25.64,92.28A24.06,24.06,0,0,1,191,184H92.16A24.06,24.06,0,0,1,69,166.42L33.92,40H16a8,8,0,0,1,0-16H40a8,8,0,0,1,7.71,5.86L57.19,64H232a8,8,0,0,1,7.71,10.14ZM221.47,80H61.64l22.81,82.14A8,8,0,0,0,92.16,168H191a8,8,0,0,0,7.71-5.86Z"></path></svg>

                    @* ✅ Badge: ใช้ Class hidden แทน if เพื่อให้ Element ยังคงอยู่ให้ JS หาเจอ *@
                    <div id="cart-badge"
                         class="@(cartCount > 0 ? "" : "hidden") absolute -top-1 -right-1 flex size-4 items-center justify-center rounded-full bg-red-600">
                        <span id="cart-count-text" class="flex items-center justify-center font-medium text-[9px] text-white">
                            @(cartCount > 99 ? "99+" : cartCount)
                        </span>
                    </div>
                </a>
            </div>

            @* --- ส่วน Wishlist --- *@
            <a href="/wishlist" class="flex items-center justify-center" aria-label="Link to Wishlist page">
                <svg xmlns="http://www.w3.org/2000/svg" class="size-6 fill-primary" fill="#000000" viewBox="0 0 256 256"><path d="M178,40c-20.65,0-38.73,8.88-50,23.89C116.73,48.88,98.65,40,78,40a62.07,62.07,0,0,0-62,62c0,70,103.79,126.66,108.21,129a8,8,0,0,0,7.58,0C136.21,228.66,240,172,240,102A62.07,62.07,0,0,0,178,40ZM128,214.8C109.74,204.16,32,155.69,32,102A46.06,46.06,0,0,1,78,56c19.45,0,35.78,10.36,42.6,27a8,8,0,0,0,14.8,0c6.82-16.67,23.15-27,42.6-27a46.06,46.06,0,0,1,46,46C224,155.61,146.24,204.15,128,214.8Z"></path></svg>
            </a>

            @* --- ส่วน Profile Dropdown --- *@
            <div class="relative inline-block text-left transition-all duration-150">
                <img id="admin-menu-button"
                     class="size-10 cursor-pointer rounded-full"
                     src="@pictureProfile"
                     alt="Profile Picture" />

                <div id="admin-menu-items"
                     class="absolute right-0 z-10 mt-2 hidden w-56 origin-top-right bg-white shadow-md ring-1 ring-border focus:outline-none"
                     role="menu"
                     tabindex="-1">

                    <div class="flex flex-col gap-3 p-1 font-medium">
                        <div class="mt-3 flex flex-col items-center justify-center gap-3">
                            <img class="size-20 rounded-full" src="@pictureProfile" alt="Profile" />
                            @if (user.Role.ToString() == "Admin")
                            {
                                <p class="flex items-center gap-3">
                                    <i class="ph-fill ph-crown text-lg text-yellow-400"></i> Admin
                                </p>
                            }
                            <p class="text-center text-sm">@user.Email</p>
                        </div>

                        <div class="mt-3">
                            <div class="mb-3 ml-2"><p class="text-sm underline">Menu</p></div>
                            @if (user.Role.ToString() == "Admin")
                            {
                                <a asp-controller="Admin" asp-action="Index" class="flex items-center gap-2 rounded-sm px-4 py-2 text-sm hover:bg-gray-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 256 256"><path d="M226.76,69a8,8,0,0,0-12.84-2.88l-40.3,37.19-17.23-3.7-3.7-17.23,37.19-40.3A8,8,0,0,0,187,29.24,72,72,0,0,0,88,96,72.34,72.34,0,0,0,94,124.94L33.79,177c-.15.12-.29.26-.43.39a32,32,0,0,0,45.26,45.26c.13-.13.27-.28.39-.42L131.06,162A72,72,0,0,0,232,96,71.56,71.56,0,0,0,226.76,69ZM160,152a56.14,56.14,0,0,1-27.07-7,8,8,0,0,0-9.92,1.77L67.11,211.51a16,16,0,0,1-22.62-22.62L109.18,133a8,8,0,0,0,1.77-9.93,56,56,0,0,1,58.36-82.31l-31.2,33.81a8,8,0,0,0-1.94,7.1L141.83,108a8,8,0,0,0,6.14,6.14l26.35,5.66a8,8,0,0,0,7.1-1.94l33.81-31.2A56.06,56.06,0,0,1,160,152Z"></path></svg>
                                    Admin
                                </a>
                            }
                            <div class="my-1 h-px flex-1 bg-border"></div>
                            <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })" class="block w-full">
                                <button type="submit" class="flex w-full items-center gap-2 rounded-sm px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 256 256"><path d="M224,104a8,8,0,0,1-16,0V59.32l-66.33,66.34a8,8,0,0,1-11.32-11.32L196.68,48H152a8,8,0,0,1,0-16h64a8,8,0,0,1,8,8Zm-40,24a8,8,0,0,0-8,8v72H48V80h72a8,8,0,0,0,0-16H48A16,16,0,0,0,32,80V208a16,16,0,0,0,16,16H176a16,16,0,0,0,16-16V136A8,8,0,0,0,184,128Z"></path></svg>
                                    Sign out
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="flex items-center gap-5">
            <a asp-area="Identity" class="border border-primary px-5 py-2 text-sm transition-colors duration-200 hover:cursor-pointer hover:bg-primary hover:text-white" asp-page="/Account/Login">Sign in</a>
        </div>
    }
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- ส่วนจัดการ Dropdown Menu ---
        const button = document.getElementById('admin-menu-button');
        const menu = document.getElementById('admin-menu-items');

        if(button && menu) {
            button.addEventListener('click', function() {
                menu.classList.toggle('hidden');
            });

            document.addEventListener('click', function(event) {
                if (!button.contains(event.target) && !menu.contains(event.target)) {
                    if (!menu.classList.contains('hidden')) {
                        menu.classList.add('hidden');
                    }
                }
            });
        }
    });

    function refreshCartCount() {
        fetch('/Cart/GetCartCount') // ต้องตรงกับชื่อ Controller และ Action
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('cart-badge');
                const countText = document.getElementById('cart-count-text');

                if (badge && countText) {
                    if (data.count > 0) {
                        badge.classList.remove('hidden'); // แสดง Badge
                        countText.innerText = data.count > 99 ? '99+' : data.count;
                    } else {
                        badge.classList.add('hidden'); // ซ่อน Badge
                    }
                }
            })
            .catch(error => console.error('Error updating cart count:', error));
    }
</script>